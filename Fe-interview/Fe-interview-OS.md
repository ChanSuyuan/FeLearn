# 操作系统

## 特征
+ 并发
+ 共享
+ 虚拟
+ 异步

其中并发与共享互为存在条件，是操作系统最基本的两个特征。

+ 并发：指的是两个或者多个事件在同一时间间隔内发生。这些事件在宏观上同时执行，在微观上交替进行。操作系统的并发性指的就是计算机系统中同时存在着多个运行着的程序。
+ 并行：指的是两个或者多个时间在同一时间时刻 内发生。

+ 共享：即是资源共享，是指系统中的资源可供内存中多个并发执行的程序共同使用。
+ 资源共享分为两种方式，分别是互斥共享方式、同时共享方式。

+ 虚拟：把一个物理上的实体变为若干逻辑上的对应物。虚拟处理器技术，实际上只有一个单核的CPU，但在用户效果上来看仿佛有6个单核CPU在运行。
+ 虚拟技术：分为时分复用技术（如虚拟处理器技术）、空分复用技术（如虚拟存储器技术）
+ 没有并发性就谈不上虚拟性。

+ 异步：在多道程序环境下，允许多个程序并发执行，但是由于资源有限，进程的执行不能一贯到底，而是走走停停，以一种不可预知的速度向前推进，这就是进程的异步性。
+ 只有系统存在并发性，才有可能导致异步。

## 运行机制
+ 指令是指就是处理器（CPU）能识别、执行的最基本命令。
+ 指令：分为特权指令（如内存清零指令）、非特权指令（如加减乘除）

+ CPU 有两种处理器状态：用户态（目态）、核心态（管态）。
+ CPU 处在用户态时只能处理非特权指令，而处于核心态，则还可以执行特权指令。

+ 两种程序：内核程序、应用程序。
+ 内核程序：系统的管理者，既可以执行特权指令，也可以执行非特权指令，处在核心态。
+ 应用程序：只能够执行非特权指令，在用户态运行。

## 操作系统内核功能
+ 时钟管理：实现计时功能。
+ 中断处理：负责实现中断机制。
+ 原语：是一种特殊的程序，处于操作系统最底层，最接近硬件的部分，这种程序具有原子性---运行只能一气呵成，不能中断。运行时间较短、调用频繁。
+ 对系统资源进行管理的功能：进程管理、存储器管理、设备管理。（有些操作系统并不此中化为操作系统功能，需要注意。）

## 操作系统的体系结构
+ 大内核：包含了进程管理、存储器管理、设备管理等功能，以及时钟管理、中断管理、原语。
+ 微内核：只包含时钟管理、中断管理、原语。



+ 大内核：将操作系统的主要功能模块都作为系统内核，运行在核心态。
+ 优点：高性能  ｜ 缺点：内核代码量大，结构混乱，难以维护。



+ 微内核：只把最基本的功能保留在内核。
+ 优点：内核功能少，结构清晰，便于维护。 ｜ 缺点：需要频繁地在核心态和用户态之间切换，性能低。

## 中断和异常
+ 中断的诞生：由于早期计算机为串行执行任务，为了提高效率，引入操作系统，带来中断机制，使得计算机能实现多道程序并发执行。其本质：发生中断就意味着需要操作系统介入，开展管理工作。

+ 中断的概念和作用
+ 当中断发生时，CPU会立即进入核心态。
+ 当中断发生后，当前运行的进程暂停运行，并由操作系统内核中断进行处理。
+ 对于不同的中断信号，会进行不同的处理。
+ 中断可以使CPU从用户态转为核心态，使操作系统获得计算机的控制权。有了中断，才能够实现多道程序并发执行。
+ 中断是唯一一种途径使得用户态转为核心态。
+ 而从核心态转为用户态则需要一种特权指令。 

+ 中断分为内中断、外中断
+ 内中断：分为自愿中断、强迫中断。
+ 自愿中断：指令中断  ｜ 强迫中断：硬件故障（如缺页）、软件中断（整除零）。
+ 外中断：外设请求（I/O操作完成发出的中断信号）、人工干预。

  

## 进程 
+ 进程：在传统进程机制中，进程是资源分配、接受调度的基本单位。进程控制块（PCB）描述进程的基本信息和运行状态，所谓的创建进程以及撤销进程，都是针对PCB的操作。
+ 程序段、数据段、PCB 三部分组成了进程实体（进程印象），一般情况下，进程实体就成为进程，所谓创建进程，实质上是创建进程实体中的PCB；而撤销进程，实质上是撤销进程实体中的PCB。（PCB是进程存在的唯一标志）
+ 进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位。
+ 进程的组成：进程描述信息、进程控制和管理信息、资源分配清单、处理机相关信息。
+ 进程描述信息：进程标识符 PID（用于区分不同进程）、用户标识符 UID。
+ 进程管理和管理信息：进程当前状态、进程优先级。
+ 资源分配清单：程序段指针、数据段指针、键盘、鼠标
+ 处理机相关信息：各种寄存器值。
+ 进程的组成方式：链接方式、索引方式。
+ 链接方式：按照进程状态将PCB分为多个队列；操作系统持有指向各个队列的指针。
+ 索引方式：根据进程状态的不同，建立几张索引表；操作系统持有指向各个索引表的指针。



+ 进程的特征：动态性、并发性、独立性、异步性、结构性
+ 动态性：进程是程序的一次执行过程，是动态地产生、变化和消亡的。
+ 并发性：内存中有多个进程实体，各进程可以并发执行。
+ 独立性：进程是能独立运行、独立获得资源、独立接受调查的基本单位。
+ 异步性：各进程按各自独立的、不可预知的速度向前推进，操作系统要提供“进程同步机制”来解决异步问题。
+ 结构性：每个进程都会配置一个 PCB。结构上看，进程由程序段、数据段、PCB 组成。



+ 进程状态：运行态、就绪态、阻塞态（这三种为基本状态）、创建态、终止态
+ 运行态：占有 CPU，并在 CPU 上运行。
+ 就绪态：已经具备运行条件，但由于没有空闲 CPU，而暂时不能运行。
+ 阻塞态（等待态）：因等待某一事件而暂时不能运行。
+ 创建态：进程正在被创建，操作系统为进程分配资源、初始化 PCB。
+ 终止态：进程正在从系统中被撤销，系统操作会回收进程拥有的资源、撤销 PCB。
+ 进程状态的转化
+ 就绪态 -> 运行态：进程被调度/
+ 运行态 -> 就绪态：时间片到，或 CPU 被其他高优先级的进程抢占。
+ 运行态 -> 阻塞态：等待系统资源分配，或等待某事件发生（主动行为）。
+ 阻塞态 -> 就绪态：资源分配到位，等待的事件发生。（被动行为）。
+ 创建态 -> 就绪态：系统完成创建进程的相关工作。
+ 运行态 -> 终止态：进程运行结束，或运行过程中遇到不可修复的错误。


## 进程间通信
+ 进程通信就是进程之间的信息交换，各进程之间的内存地址空间相对独立。
+ 而为了保证系统安全，一个进程是不能直接访问另一个进程的地址空间。
+ 进程间通信：共享存储、管道通信、消息传递。

+ 共享存储：基于数据结构的共享、基于存储区的共享。
+ 因为进程之间不能够直接进行相互访问，故而操作系统为进程提供了一个共享空间。而对于这个共享空间的访问必须是互斥的。当进程1在访问共享空间时，进程2不能进行访问。
+ 基于数据结构的共享：就比如共享空间里只能存放一个长度为10的数组。这种共享方式速度慢、限制多，是一种低级通信方式。
+ 基于存储区的共享：在内存中画出一块共享存储区，数据的形式、存放位置都是由进程控制，而不是操作系统。相比之下，这种共享方式更快，是一种高级的通信方式。




+ 消息传递：直接通信方式、间接通信方式。
+ 进程间的数据交换以格式化的消息为单位。进程通过操作系统提供的“发送消息/接收消息”两个原语进行数据交换。
+ ![image-20211024145151114](/Users/chensiyuan/Library/Application Support/typora-user-images/image-20211024145151114.png)




+ 管道通信
+ 管道：是指用于连接读写进程的一个共享文件，又名 pipe 文件。其实就是在内存中开辟一个大小固定的缓冲区。
+ 管道只能采用半双工通信，某一时间段内只能实现单向的传输。如果要实现双向同时通信，则需要设置两个管道。
+ 各进程对于管道的访问也应当是互斥的。
+ 对于管道的读写，数据是以字符流的形式写入管道，当管道写满的时候，写进程的 write() 系统调用将被阻塞，等待读进程将数据去走。当读进程将数据全部取走后，管道变空，此时读进程的 read() 系统调用将被阻塞。
+ 如果没有写满管道，是不允许读的。如果没有读空管道，也是不允许写的。
+ 管道中你的数据一旦被读出，就从管道中被抛弃，这就意味着读进程最多只能有一个，否则可能会有读错数据的情况。



## 线程
+ 线程是程序执行流的最小单位，是基本的 CPU 执行单位。
+ 一个进程由多个线程组成。
+ 在引入线程之后，线程是调度的基本单位，进程是资源分配的基本单位。
+ 在引入线程之后，各线程之间也能并发，提高了并发度。
+ 线程间并发，如果是同一进程内线程切换，则不需要切换进程环境，系统开销小。
+ 引入线程之后，并发所带来的系统开销减小。
+ ![image-20211024162701921](/Users/chensiyuan/Library/Application Support/typora-user-images/image-20211024162701921.png)

+ 多线程模型：多个用户以及线程映射到一个内核级线程。每个用户进程只对应一个内核级线程。
+ 优点：用户级线程的切换在用户空间即可完成，不需要切换到核心态，线程管理的系统开销小，效率高。
+ 缺点：当一个用户级线程被阻塞后，整个进程都会被阻塞，并发度不高。多个线程不可在多核处理机上并行运行。
+ ![image-20211024163330010](/Users/chensiyuan/Library/Application Support/typora-user-images/image-20211024163330010.png)
+ 一对一模型：一个用户及线程映射到一个内核级线程。每个用户进程有与用户级线程同数量的内核级线程。
+ 优点：当一个线程被阻塞后，别的线程还可以继续执行，并发能力强。多线程可在多核处理机上并行执行。
+ 缺点：一个用户进程会占用多个内核级线程，线程切换由操作系统内核完成，需要切换到核心态，因此线程管理的成本高，开销大。
+ ![image-20211024163700946](/Users/chensiyuan/Library/Application Support/typora-user-images/image-20211024163700946.png)
+ 多对多模型
+ ![image-20211024163739354](/Users/chensiyuan/Library/Application Support/typora-user-images/image-20211024163739354.png)


### 进程调度算法



#### 批处理系统

- **先来先服务 FCFS：** 非抢占式的调度算法，按照请求的顺序进行调度。**有利于长作业，但不利于短作业，因为短作业必须一直等待前面的长作业执行完毕才能执行，而长作业又需要执行很长时间，造成了短作业等待时间过长。**
- 短作业优先 SJF：非抢占式的调度算法，按估计运行时间最短的顺序进行调度。**长作业有可能会饿死，处于一直等待短作业执行完毕的状态。因为如果一直有短作业到来，那么长作业永远得不到调度。**

- **最短剩余时间优先 SRTN：**最短作业优先的抢占式版本，按剩余运行时间的顺序进行调度。**当一个新的作业到达时，其整个运行时间与当前进程的剩余时间作比较。如果新的进程需要的时间更少，则挂起当前进程，运行新的进程。否则新的进程等待。**

 





